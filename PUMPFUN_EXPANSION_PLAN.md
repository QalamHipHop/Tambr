# طرح جامع گسترش و معماری نهایی: ادغام امکانات پلتفرم‌های DBC در پروژه Tambr (ریال‌توکن)

این سند، طرح جامع و معماری نهایی برای گسترش پروژه **Tambr (ریال‌توکن)** است تا تمام ویژگی‌های کلیدی پلتفرم‌های **DBC** را در خود جای دهد، در حالی که ساختار Monorepo موجود و ویژگی‌های پیشرفته مانند KYC/AML و Social Recovery Wallet (SRW) حفظ شوند. هدف، تبدیل Tambr به یک پلتفرم کامل، بی‌نقص و آماده تولید برای راه‌اندازی توکن‌های جدید با پشتوانه ریالی و منطق DBC است.

## ۱. نقشه ویژگی‌ها: پلتفرم‌های DBC در مقابل Tambr

پروژه Tambr در حال حاضر دارای یک هسته مالی قوی (DBC، Stablecoin) و ویژگی‌های سازمانی (KYC، SRW، Gasless) است. ادغام ویژگی‌های DBC نیازمند تغییر تمرکز DBC از یک منحنی قیمت‌گذاری ثابت به یک مکانیزم کشف قیمت پویا و خودکار است.

| ویژگی پلتفرم DBC | هدف اصلی | پیاده‌سازی در Tambr | جزء معماری |
| :--- | :--- | :--- | :--- |
| **ایجاد توکن فوری** | راه‌اندازی توکن بدون کد و کم‌هزینه. | ایجاد یک رابط کاربری ساده در `frontend` برای تعریف پارامترهای توکن و فراخوانی تابع `createToken` در قرارداد DBC. | `frontend`, `contracts` |
| **منحنی پیوند (Bonding Curve)** | کشف قیمت توکن بر اساس عرضه و تقاضا. | **اصلاح DBC موجود** برای استفاده از فرمول $x \cdot y = k$ با **ذخایر مجازی** (Virtual Reserves) برای شبیه‌سازی AMM و کنترل قیمت اولیه. | `contracts` |
| **مهاجرت نقدینگی خودکار (ALP)** | انتقال توکن‌ها از DBC به یک DEX استاندارد پس از رسیدن به آستانه. | پیاده‌سازی منطق `migrateToAMM` در قرارداد DBC که پس از رسیدن به آستانه Market Cap، نقدینگی را به یک AMM محلی (مانند Uniswap V2/V3 Clone) اضافه و قفل کند. | `contracts`, `backend` |
| **مدل راه‌اندازی عادلانه** | عدم وجود پیش‌فروش یا تخصیص تیم از استخر DBC. | تضمین می‌شود که تمام توکن‌های DBC از طریق خرید عمومی توزیع شوند. | `contracts` |

## ۲. اصلاح معماری بلاکچین (`packages/contracts`)

هسته اصلی این گسترش، بازنویسی منطق **Dynamic Bonding Curve (DBC)** است تا از مدل ذخایر مجازی DBC استفاده کند.

### ۲.۱. قرارداد DynamicBondingCurve.sol (DBC)

1.  **استفاده از مدل AMM با ذخایر مجازی:**
    *   به جای استفاده از فرمول‌های خطی یا گسسته، از فرمول **محصول ثابت** ($x \cdot y = k$) استفاده می‌شود.
    *   **ذخایر مجازی (Virtual Reserves):** دو متغیر `virtualBaseReserve` (معادل SOL/IRR) و `virtualTokenReserve` برای محاسبه قیمت استفاده می‌شوند. این ذخایر با هر خرید/فروش به‌روز می‌شوند.
    *   **قیمت‌گذاری:** قیمت توکن بر اساس نسبت ذخایر مجازی محاسبه می‌شود: $\text{Price} = \frac{\text{virtualBaseReserve}}{\text{virtualTokenReserve}}$.

2.  **مکانیزم Automated Liquidity Provision (ALP):**
    *   **آستانه مهاجرت:** یک متغیر `migrationThreshold` (بر اساس Market Cap یا Base Reserve جمع‌آوری شده) تعریف می‌شود.
    *   **تابع `migrateToAMM()`:**
        *   پس از رسیدن به آستانه، این تابع توسط یک سرویس بک‌اند (Relayer/Backend) فراخوانی می‌شود.
        *   **محاسبه نقدینگی:** تمام Base Currency (IRR) جمع‌آوری شده در DBC و توکن‌های باقی‌مانده، به عنوان نقدینگی اولیه به یک قرارداد AMM (مثلاً `UniswapV2Pair` Clone) ارسال می‌شوند.
        *   **قفل نقدینگی:** توکن‌های LP (Liquidity Provider) دریافت شده، به یک قرارداد قفل نقدینگی (Liquidity Locker) ارسال می‌شوند تا از "Rug Pull" جلوگیری شود.
        *   **تغییر وضعیت:** وضعیت DBC به `MIGRATED` تغییر می‌کند و خرید/فروش از طریق DBC متوقف می‌شود.

3.  **تضمین فنی سهم شما (Founder's Share):**
    *   **کارمزد:** کارمزد معاملات (مثلاً ۰.۸٪) همچنان در توابع `buy()` و `sell()` محاسبه می‌شود.
    *   **تخصیص سهم:** ۰.۱٪ از کارمزد کل معاملات به صورت خودکار به `FOUNDER_ADDRESS` (آدرس ثابت شما) منتقل می‌شود. این منطق در قرارداد DBC حفظ و تقویت خواهد شد.

## ۳. گسترش سرویس‌های بک‌اند و رله (`packages/backend` و `packages/relayer`)

برای پشتیبانی از مکانیزم ALP و تجربه کاربری Tambr Launchpad، سرویس‌های بک‌اند نیاز به گسترش دارند.

| سرویس | وظیفه جدید | جزئیات فنی |
| :--- | :--- | :--- |
| **Backend (Oracle)** | رصد آستانه مهاجرت | ایجاد یک Cron Job در NestJS برای رصد Market Cap توکن‌های DBC. |
| **Backend (Oracle)** | فراخوانی ALP | پس از رسیدن به آستانه، سرویس Backend با استفاده از کلید خصوصی خود، تابع `migrateToAMM()` را در قرارداد DBC فراخوانی می‌کند. |
| **Relayer** | تراکنش‌های Gasless | حفظ قابلیت Gasless برای تراکنش‌های خرید/فروش DBC، حتی پس از مهاجرت (برای تراکنش‌های AMM). |
| **Backend (API Gateway)** | APIهای توکن | ایجاد APIهایی برای لیست کردن توکن‌های فعال DBC، نمایش نمودار قیمت و وضعیت مهاجرت. |

## ۴. طراحی رابط کاربری و تجربه کاربری (`packages/frontend`)

رابط کاربری باید سادگی و سرعت Tambr Launchpad را منعکس کند، در حالی که ویژگی‌های پیشرفته Tambr را به صورت یکپارچه ارائه دهد.

1.  **صفحه راه‌اندازی توکن (Launchpad):**
    *   یک فرم ساده برای وارد کردن نام توکن، نماد، توضیحات و تصویر.
    *   پشت این فرم، منطق پیچیده DBC و Stablecoin قرار دارد.
    *   **یکپارچگی KYC:** کاربر قبل از راه‌اندازی توکن باید احراز هویت سطح ۱ (KYC) را تکمیل کرده باشد (استفاده از ماژول `KycModule` در Backend).

2.  **صفحه معاملات توکن (Trading Interface):**
    *   نمایش نمودار قیمت لحظه‌ای (بر اساس ذخایر مجازی DBC).
    *   فرم‌های خرید و فروش ساده با نمایش تأثیر تراکنش بر قیمت (Price Impact).
    *   نمایش وضعیت DBC (فعال، نزدیک به مهاجرت، مهاجرت شده به AMM).

3.  **داشبورد کاربر:**
    *   نمایش توکن‌های راه‌اندازی شده توسط کاربر.
    *   نمایش سهم بنیان‌گذار (Founder's Share) از کارمزد معاملات.
    *   رابط کاربری Social Recovery Wallet (SRW) برای مدیریت کلیدها.

## ۵. نقشه راه پیاده‌سازی (Implementation Roadmap)

| فاز | وظیفه | جزء معماری |
| :--- | :--- | :--- |
| **۴.۱. DBC پیشرفته** | بازنویسی `DynamicBondingCurve.sol` با منطق ذخایر مجازی و ALP. | `contracts` |
| **۴.۲. AMM محلی** | پیاده‌سازی یک قرارداد AMM ساده (Uniswap V2 Clone) برای Sidechain. | `contracts` |
| **۴.۳. قفل نقدینگی** | پیاده‌سازی قرارداد `LiquidityLocker.sol` برای قفل کردن توکن‌های LP. | `contracts` |
| **۴.۴. سرویس رصد ALP** | ایجاد Cron Job در `packages/backend` برای رصد آستانه و فراخوانی `migrateToAMM`. | `backend` |
| **۴.۵. رابط کاربری Launchpad** | پیاده‌سازی صفحه راه‌اندازی توکن با یکپارچگی KYC. | `frontend` |
| **۴.۶. رابط کاربری معاملات** | به‌روزرسانی صفحه معاملات برای نمایش نمودار DBC و وضعیت ALP. | `frontend` |
| **۴.۷. تست نهایی** | تست کامل DBC، ALP و یکپارچگی Gasless. | `contracts`, `backend`, `relayer` |

این طرح، یک نقشه راه عملیاتی برای تبدیل Tambr به یک پلتفرم پیشرفته و بی‌نقص در سطح جهانی است که تمام خواسته‌های شما را در بر می‌گیرد.
