# گزارش توسعه و ارتقاء قرارداد هوشمند SmartTicket

## مقدمه

بر اساس درخواست شما برای درک، توسعه، و تکمیل قرارداد هوشمند موجود در پروژه Tambr، تمرکز اصلی بر روی فایل `SmartTicket.sol` قرار گرفت. این قرارداد، که هسته سیستم بلیت‌فروشی NFT شماست، ارتقاء یافت تا از نظر امنیتی، انعطاف‌پذیری و استانداردسازی به سطح بالاتری برسد.

## خلاصه تغییرات اعمال شده

قرارداد `SmartTicket.sol` با هدف تبدیل شدن به یک کد کامل و بی‌نقص، دستخوش سه تغییر عمده شد:

1.  **پیاده‌سازی کنترل دسترسی مبتنی بر نقش (RBAC):** جایگزینی `Ownable` با `AccessControl` برای تفکیک وظایف و افزایش امنیت.
2.  **غنی‌سازی متادیتا (Metadata):** افزودن جزئیات رویداد و نوع بلیت به ساختار داده هر NFT.
3.  **استانداردسازی کد:** استفاده از کتابخانه‌های استاندارد OpenZeppelin برای بهینه‌سازی.

---

## ۱. ارتقاء امنیت: کنترل دسترسی مبتنی بر نقش (RBAC)

سیستم قبلی که تنها به مالک قرارداد (Owner) اجازه صدور و ابطال بلیت را می‌داد، برای یک سیستم بلیت‌فروشی مقیاس‌پذیر مناسب نبود. با پیاده‌سازی `AccessControl`، وظایف کلیدی تفکیک شدند:

| نقش (Role) | وظیفه | توابع تحت کنترل |
| :--- | :--- | :--- |
| `DEFAULT_ADMIN_ROLE` | مدیریت کلی قرارداد، اعطای نقش‌ها، تنظیم حق امتیاز (Royalty) و Base URI. | `setRoyalty`, `setBaseURI`, `grantRole`, `revokeRole` |
| `MINTER_ROLE` | صدور بلیت‌های جدید (Minting). | `mint`, `mintBatch` |
| `REDEEMER_ROLE` | تأیید و ابطال بلیت‌های استفاده شده (Redeeming). | `redeemTicket` |

**مزیت:** این ساختار به شما اجازه می‌دهد تا وظایف را به آدرس‌های مختلفی واگذار کنید. به عنوان مثال، یک آدرس می‌تواند مسئول صدور بلیت باشد (Minter) و آدرس دیگری (مثلاً یک دستگاه اسکنر در ورودی) مسئول ابطال بلیت‌ها (Redeemer) باشد، بدون اینکه هر دو نیاز به دسترسی کامل ادمین داشته باشند.

## ۲. غنی‌سازی متادیتا و جزئیات بلیت

برای اینکه هر NFT بلیت، اطلاعات معناداری از رویداد را در خود داشته باشد، یک ساختار داده جدید به نام `TicketDetails` اضافه شد:

```solidity
struct TicketDetails {
    uint256 eventId;
    string ticketType;
}
```

توابع `mint` و `mintBatch` اکنون پارامترهای جدیدی (`eventId` و `ticketType`) را دریافت می‌کنند و این جزئیات را در قرارداد ذخیره می‌کنند.

**تابع جدید:**
*   `getTicketDetails(uint256 tokenId)`: این تابع به هر کسی اجازه می‌دهد تا جزئیات رویداد و نوع بلیت مرتبط با یک توکن خاص را مشاهده کند.

## ۳. استانداردسازی و بهینه‌سازی کد

*   **حذف تابع کمکی:** تابع داخلی و سفارشی `_toString` که در نسخه قبلی برای تبدیل `uint256` به `string` استفاده می‌شد، حذف گردید.
*   **استفاده از کتابخانه استاندارد:** به جای آن، از کتابخانه استاندارد و بهینه‌شده `Strings.sol` از OpenZeppelin استفاده شد. این کار باعث کاهش حجم کد، افزایش خوانایی و اطمینان از عملکرد بهینه می‌شود.

## نتیجه نهایی و کد کامل

قرارداد `SmartTicket.sol` اکنون یک قرارداد هوشمند بلیت‌فروشی کامل، امن و استاندارد است که از آخرین بهترین شیوه‌های توسعه Solidity پیروی می‌کند.

**فایل‌های نهایی ارائه شده:**

1.  **`SmartTicket.sol`**: قرارداد هوشمند ارتقاء یافته با RBAC و متادیتای غنی‌شده.
2.  **`SmartTicket.test.ts`**: فایل تست کامل Hardhat که صحت عملکرد تمام توابع جدید و کنترل‌های دسترسی را تأیید می‌کند. (تمام تست‌ها با موفقیت اجرا شدند).

این تغییرات، پروژه شما را به سمت یک سیستم بلیت‌فروشی غیرمتمرکز، قوی و آماده برای استفاده در محیط‌های واقعی سوق می‌دهد.

---
**توجه:** برای استفاده از قرارداد جدید، در هنگام استقرار (Deployment) باید آدرس‌های اولیه برای نقش‌های `_admin`، `_minter` و `_redeemer` را در تابع `constructor` مشخص کنید.

```solidity
constructor(
    string memory name,
    string memory symbol,
    string memory _baseURI,
    address _admin,
    address _minter,
    address _redeemer,
    address _royaltyReceiver,
    uint96 _royaltyPercentage
)
```
